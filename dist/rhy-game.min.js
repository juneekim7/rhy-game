"use strict";class Judgement{static miss=new Judgement("miss",0,!1);name;time;isCombo;constructor(e,t,i=!0){if(t<0)throw Error("judgement time must be not negative");this.name=e,this.time=t,this.isCombo=i}}class Note{expectedTime;classNames;moveAnimation;fadeAnimation;timingFunction;sizeRatio;isDeleted;createDOM(e,t,i,s){if(this.isDeleted||0===this.sizeRatio)return;let n=document.createElement("div");for(let o of this.classNames){let a=n.getAttribute("class")??"";n.setAttribute("class",a+" "+o)}n.style.setProperty("--size",`calc(${i} * ${this.sizeRatio})`),n.style.animation=`${t}ms ${this.timingFunction} ${this.moveAnimation}`,n.addEventListener("animationend",()=>{n.style.animation=`${t/s*this.sizeRatio}ms ${this.timingFunction} ${this.fadeAnimation}`,n.addEventListener("animationend",()=>{this.isDeleted=!0,n.remove()})}),e.appendChild(n)}judge(e,t){if(this.isDeleted)return"none";let i=Math.abs(t-this.expectedTime);for(let s of e)if(i<s.time)return this.isDeleted=!0,s;return t<this.expectedTime?"none":(this.isDeleted=!0,Judgement.miss)}constructor(e,{classNames:t=["note"],moveAnimation:i="move",fadeAnimation:s="fade",timingFunction:n="linear",sizeRatio:o=.1}={}){this.expectedTime=e,this.isDeleted=!1,this.classNames=t,this.moveAnimation=i,this.fadeAnimation=s,this.timingFunction=n,this.sizeRatio=o}}class Normal extends Note{constructor(e,{classNames:t=["note","normal"],moveAnimation:i="move",fadeAnimation:s="fade",timingFunction:n="linear",sizeRatio:o=.1}={}){super(e,{classNames:t,moveAnimation:i,fadeAnimation:s,timingFunction:n,sizeRatio:o})}}class Long extends Note{classNames=["note","long"];sizeRatio=1;constructor(e,t,{classNames:i=["note","long"],moveAnimation:s="move",fadeAnimation:n="fade",timingFunction:o="linear",sizeRatio:a=1}={}){super(e,{classNames:i,moveAnimation:s,fadeAnimation:n,timingFunction:o,sizeRatio:a});let{lane:r,index:l}=t,m=r[l],c=1;if(l>0&&r[l-1]===m){this.isDeleted=!0;return}for(;r[l+c]===m;)c++;this.sizeRatio=c}}class Tap extends Normal{constructor(e,{classNames:t=["note","normal","tap"],moveAnimation:i="move",fadeAnimation:s="fade",timingFunction:n="linear",sizeRatio:o=.1}={}){super(e,{classNames:t,moveAnimation:i,fadeAnimation:s,timingFunction:n,sizeRatio:o})}}class Hold extends Long{constructor(e,t,{classNames:i=["note","long","hold"],moveAnimation:s="move",fadeAnimation:n="fade",timingFunction:o="linear",sizeRatio:a=.1}={}){super(e,t,{classNames:i,moveAnimation:s,fadeAnimation:n,timingFunction:o,sizeRatio:a})}}class Drag extends Tap{constructor(e,{classNames:t=["note","normal","tap","drag"],moveAnimation:i="move",fadeAnimation:s="fade",timingFunction:n="linear",sizeRatio:o=.1}={}){super(e,{classNames:t,moveAnimation:i,fadeAnimation:s,timingFunction:n,sizeRatio:o})}}class Flick extends Tap{constructor(e,{classNames:t=["note","normal","tap","flick"],moveAnimation:i="move",fadeAnimation:s="fade",timingFunction:n="linear",sizeRatio:o=.1}={}){super(e,{classNames:t,moveAnimation:i,fadeAnimation:s,timingFunction:n,sizeRatio:o})}}class HoldFlick extends Hold{constructor(e,t,{classNames:i=["note","long","hold","hold-flick"],moveAnimation:s="move",fadeAnimation:n="fade",timingFunction:o="linear",sizeRatio:a=.1}={}){super(e,t,{classNames:i,moveAnimation:s,fadeAnimation:n,timingFunction:o,sizeRatio:a})}}class Info{music;title;artist;difficulty;bpm;split;delay;cover;background;get timePerBeat(){return 24e4/this.bpm/this.split}constructor(e){this.music=e.music,this.title=e.title,this.artist=e.artist,this.difficulty=e.difficulty,this.bpm=e.bpm,e.split?this.split=e.split:this.split=16,this.split=e.split,e.delay?this.delay=e.delay:this.delay=0,this.cover=e.cover,this.background=e.background}}class Song{info;chart;constructor({info:e,chart:t}){this.info=new Info(e),this.chart=t}}class Timer{initTime;getTime(){return new Date().getTime()-this.initTime}constructor(e=new Date().getTime()){this.initTime=e}}class Game{DOM;notes;judgements;maxScore;delay;sizePerBeat;#a;createdNotes={};set laneSizeRatio(e){this.#a=e,document.documentElement.style.setProperty("--lane-size",`calc(${this.sizePerBeat} * ${e})`)}get laneSizeRatio(){return this.#a}loadNote(e,t){if(!(t in e.chart))throw Error(`there is no mode ${t} in the song ${e.info.title}`);if(0===e.chart[t].length)throw Error(`there is no information in the mode ${t} of the song ${e.info.title}`);let i={};for(let s of e.chart[t])for(let n in s)n in this.DOM&&(i[n]||(i[n]=""),i[n]+=s[n].replace(/\|/g,""),this.createdNotes[n]=[]);let o=0,a=e.info.timePerBeat*this.laneSizeRatio,r=new Timer;setInterval(()=>{for(let t in i){let s=i[t];if(o===s.length)return;let n=s[o];if(n in this.notes){let l=this.notes[n](r.getTime(),{lane:s,index:o,timePerBeat:e.info.timePerBeat});l.createDOM(this.DOM[t],a,this.sizePerBeat,this.laneSizeRatio),this.createdNotes[t].push(l)}}o++},e.info.timePerBeat)}play(e,t){let i=new Audio(e.info.music),s=e.info.timePerBeat*this.laneSizeRatio;setTimeout(()=>{this.loadNote(e,t)},0),setTimeout(()=>{i.play()},s+this.delay),console.log(`${e.info.title} start`)}judgeLane(e,t){if(0===this.createdNotes[e].length)return;let i=this.createdNotes[e][0];if(i.isDeleted){this.createdNotes[e].shift(),this.judgeLane(e,t);return}let s=i.judge(this.judgements,t);"none"!==s&&this.createdNotes[e].shift()}constructor({DOM:e={},notes:t={n:e=>new Tap(e),l:(e,t)=>new Hold(e,t),d:e=>new Drag(e),f:e=>new Flick(e),x:(e,t)=>new HoldFlick(e,t)},judgements:i=[new Judgement("perfect",40,!0),new Judgement("great",100,!0),new Judgement("great",100,!0),new Judgement("bad",500,!1)],maxScore:s=1e5,delay:n=0,sizePerBeat:o="100px",laneSizeRatio:a=8}={}){this.DOM=e,this.notes=t,this.judgements=i.sort((e,t)=>e.time-t.time),this.maxScore=s,this.delay=n,"number"==typeof o&&(o+="px"),this.sizePerBeat=o,this.#a=a,this.laneSizeRatio=a}}
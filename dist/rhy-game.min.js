"use strict";class Judgement{name;time;isCombo;constructor(t,e,i=!0){this.name=t,this.time=e,this.isCombo=i}}class Note{classNames;moveAnimation;fadeAnimation;timingFunction;sizeRatio;createDOM(t,e,i,s){if(0===this.sizeRatio)return;let n=document.createElement("div");for(let o of this.classNames){let a=n.getAttribute("class")??"";n.setAttribute("class",a+" "+o)}n.style.setProperty("--size",`calc(${i} * ${this.sizeRatio})`),n.style.animation=`${e}ms ${this.timingFunction} ${this.moveAnimation}`,n.addEventListener("animationend",()=>{n.style.animation=`${e/s*this.sizeRatio}ms ${this.timingFunction} ${this.fadeAnimation}`,n.addEventListener("animationend",()=>{n.remove()})}),t.appendChild(n)}constructor(t,e,{classNames:i=["note"],moveAnimation:s="move",fadeAnimation:n="fade",timingFunction:o="linear",sizeRatio:a=.1}={}){this.classNames=i,this.moveAnimation=s,this.fadeAnimation=n,this.timingFunction=o,this.sizeRatio=a}}class Normal extends Note{constructor(t,e,{classNames:i=["note","normal"],moveAnimation:s="move",fadeAnimation:n="fade",timingFunction:o="linear",sizeRatio:a=.1}={}){super(t,e,{classNames:i,moveAnimation:s,fadeAnimation:n,timingFunction:o,sizeRatio:a})}}class Long extends Note{classNames=["note","long"];sizeRatio=1;constructor(t,e,{classNames:i=["note","long"],moveAnimation:s="move",fadeAnimation:n="fade",timingFunction:o="linear",sizeRatio:a=1}={}){super(t,e,{classNames:i,moveAnimation:s,fadeAnimation:n,timingFunction:o,sizeRatio:a});let l=t[e],r=1;if(e>0&&t[e-1]===l)r=0;else for(;t[e+r]===l;)r++;this.sizeRatio=r}}class Tap extends Normal{constructor(t,e,{classNames:i=["note","normal","tap"],moveAnimation:s="move",fadeAnimation:n="fade",timingFunction:o="linear",sizeRatio:a=.1}={}){super(t,e,{classNames:i,moveAnimation:s,fadeAnimation:n,timingFunction:o,sizeRatio:a})}}class Hold extends Long{constructor(t,e,{classNames:i=["note","long","hold"],moveAnimation:s="move",fadeAnimation:n="fade",timingFunction:o="linear",sizeRatio:a=.1}={}){super(t,e,{classNames:i,moveAnimation:s,fadeAnimation:n,timingFunction:o,sizeRatio:a})}}class Drag extends Tap{constructor(t,e,{classNames:i=["note","normal","tap","drag"],moveAnimation:s="move",fadeAnimation:n="fade",timingFunction:o="linear",sizeRatio:a=.1}={}){super(t,e,{classNames:i,moveAnimation:s,fadeAnimation:n,timingFunction:o,sizeRatio:a})}}class Flick extends Tap{constructor(t,e,{classNames:i=["note","normal","tap","flick"],moveAnimation:s="move",fadeAnimation:n="fade",timingFunction:o="linear",sizeRatio:a=.1}={}){super(t,e,{classNames:i,moveAnimation:s,fadeAnimation:n,timingFunction:o,sizeRatio:a})}}class HoldFlick extends Hold{constructor(t,e,{classNames:i=["note","long","hold","hold-flick"],moveAnimation:s="move",fadeAnimation:n="fade",timingFunction:o="linear",sizeRatio:a=.1}={}){super(t,e,{classNames:i,moveAnimation:s,fadeAnimation:n,timingFunction:o,sizeRatio:a})}}class Info{music;title;artist;difficulty;bpm;split;delay;cover;background;get timePerBeat(){return 24e4/this.bpm/this.split}constructor(t){this.music=t.music,this.title=t.title,this.artist=t.artist,this.difficulty=t.difficulty,this.bpm=t.bpm,t.split?this.split=t.split:this.split=16,this.split=t.split,t.delay?this.delay=t.delay:this.delay=0,this.cover=t.cover,this.background=t.background}}class Song{info;chart;constructor({info:t,chart:e}){this.info=new Info(t),this.chart=e}}class Game{DOM;notes;judgements;maxScore;delay;sizePerBeat;#a;set laneSizeRatio(t){this.#a=t,document.documentElement.style.setProperty("--lane-size",`calc(${this.sizePerBeat} * ${t})`)}get laneSizeRatio(){return this.#a}loadNote(t,e){if(!(e in t.chart))throw Error(`there is no mode ${e} in the song ${t.info.title}`);if(0===t.chart[e].length)throw Error(`there is no information in the mode ${e} of the song ${t.info.title}`);let i={};for(let s of t.chart[e])for(let n in s)n in this.DOM&&(i[n]||(i[n]=""),i[n]+=s[n].replace(/\|/g,""));let o=0,a=t.info.timePerBeat*this.laneSizeRatio;console.log(t.info.timePerBeat),setInterval(()=>{for(let t in i){let e=i[t];if(o===e.length)return;let s=e[o];if(s in this.notes){let n=this.notes[s](e,o);n.createDOM(this.DOM[t],a,this.sizePerBeat,this.laneSizeRatio)}}o++},t.info.timePerBeat)}play(t,e){let i=new Audio(t.info.music),s=t.info.timePerBeat*this.laneSizeRatio;setTimeout(()=>{this.loadNote(t,e)},0),setTimeout(()=>{i.play()},s+this.delay),console.log(`${t.info.title} start`)}constructor({DOM:t={},notes:e={n:(t,e)=>new Tap(t,e),l:(t,e)=>new Hold(t,e),d:(t,e)=>new Drag(t,e),f:(t,e)=>new Flick(t,e),x:(t,e)=>new HoldFlick(t,e)},judgements:i=[new Judgement("perfect",40,!0),new Judgement("great",100,!0),new Judgement("great",100,!0),new Judgement("bad",500,!1)],maxScore:s=1e5,delay:n=0,sizePerBeat:o="100px",laneSizeRatio:a=8}={}){this.DOM=t,this.notes=e,this.judgements=i,this.maxScore=s,this.delay=n,"number"==typeof o&&(o+="px"),this.sizePerBeat=o,this.#a=a,this.laneSizeRatio=a}}